<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>WoD</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.js'></script>
<script src='drones_flights_05012015.geojson'></script>
<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.css' rel='stylesheet' />

<style>
  html, body { margin:0; padding:0; height: 100%; }
  #map { width:100%; height: 100%; }
  .info {
        padding: 6px 8px;
        font: 12px/14px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255,255,255,1);
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        border-radius: 5px;
        width: 300px;
    }
    .info h4 {
        margin: 0 0 5px;
        color: #333;
    }
</style>
</head>
<body>
<!--FILTERS -->
                <div style="z-index:2; position:absolute; left: 80px" id="flight-filters">
                  <h4 style="display:inline-block">Filters:</h4> 
                        <select id="missionFilter" class="filter selectboxes">
                          <option value="default" label="Filter by Mission Type (All)">Select Mission Type</option>
                          <option value="Agriculture" label="Agriculture">Agriculture</option>
                          <option value="Archaeology" label="Archaeology">Archaeology</option>
                          <option value="Armed Conflict Monitoring" label="Armed Conflict Monitoring">Armed Conflict Monitoring</option>
                          <option value="Cargo" label="Cargo">Cargo</option>
                          <option value="Community Mapping" label="Community Mapping">Community Mapping</option>
                          <option value="Current Events" label="Current Events">Current Events</option>
                          <option value="Disaster Response" label="Disaster Response">Disaster Response</option>
                          <option value="Environmental Surveying" label="Environmental Surveying">Environmental Surveying</option>
                          <option value="Search and Rescue" label="Search and Rescue">Search and Rescue</option>
                          <option value="Training" label="Training">Training</option>
                          <option value="Other" label="Other">Other</option>
                          <option value="Wildlife Surveying" label="Wildlife Surveying">Wildlife Surveying</option>
                        </select> 
                        <select id="costFilter" class="filter selectboxes">
                          <option value="default" label="Filter by Cost (All) ($USD)">Cost</option>
                          <option value="Under" label="Below $10K">Below $10K</option>
                          <option value="Over" label="Above $10K">Above $10K</option>
                          </select>
                        <select id="typeFilter" class="filter selectboxes">
                          <option value="default" label="Filter by Drone Type (All)">Type of Drone</option>
                          <option value="Multirotor" label="Multirotor">Multirotor</option>
                          <option value="Fixed Wing" label="Fixed Wing">Fixed Wing</option>
                          <option value="NA" label="Multiple, Other or Unknown">Multiple, Other or Unknown</option>
                        </select>
                        <span>Date Range:</span>
                        <div id="date-range" style="display: inline-block; margin-left:20px; width:300px"></div>
                    </div>

<div id='map'></div>
<script>

L.mapbox.accessToken = 'pk.eyJ1IjoibmV3YW1lcmljYSIsImEiOiIyM3ZnYUtrIn0.57fFgg_iM7S1wLH2GQC71g';
var map = L.mapbox.map('map', 'newamerica.l89jcfpc', {
        maxZoom: 13,
        minZoom: 2,
        
        tileLayer: {
            continuousWorld: false,
            noWrap: true
        }
    });
        map.scrollWheelZoom.disable();


        var markerOptions = {
            radius: 8,
            fillColor: "#2dbbb3",
            color: "#000",
            weight: 0.5,
            opacity: 0.5,
            fillOpacity: 0.8
          };

        function style(feature) {
            return {
                color: '#2dbbb3',
                weight: 1.5,
                fillOpacity: 0.05,
                fillColor: "#fff"
            };
        }

        // control that shows state info on hover
        var info = L.control();

        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };

        info.update = function (props) {
            this._div.innerHTML = '<h4>Click to learn about a drone flight.</h4>';
        };

        info.addTo(map);

        var myLayer;

        function highlightFeature(e) {
            var layer = e.target;
            $('.info').html(layer.feature.properties.popupContent);
            layer.setStyle({
                weight: 5,
                color: '#2dbbb3',
                fillOpacity: 0.5,
                fillColor: "#2dbbb3"
            });

            if (!L.Browser.ie && !L.Browser.opera) {
                layer.bringToFront();
            }
        }


        function resetHighlight(e) {
            myLayer.resetStyle(e.target);
            $('.info').html('<h4>Click on a country.</h4>');
        }

        var lastClickedLayer;

        function zoomToFeature(e) {
            if(lastClickedLayer){
                myLayer.resetStyle(lastClickedLayer);
            }
            var layer = e.target;

            $('.info').html(layer.feature.properties.popupContent);

            layer.setStyle({
                weight: 5,
                color: '#2dbbb3',
                fillOpacity: 0.5,
                fillColor: "#2dbbb3"
            });

            if (!L.Browser.ie && !L.Browser.opera) {
                layer.bringToFront();
            }

            //$('.info').panel('open');
            lastClickedLayer = layer;
        }


        function onEachFeature(feature, layer) {
            layer.on({
                    //mouseover: highlightFeature,
                    //mouseout: resetHighlight,
                    click: zoomToFeature
                });

            var props = feature.properties;
            //sources
            var source = props.reference_url1;
            var source_arr = source.split("; ");
            var sources = [];

             for(i=0;i< source_arr.length; i++){
                     var t = source_arr[i].split(": ");
                     var p = '<a href="' + encodeURI(t[1]) + '" target="_blank" >' + t[0] + '</a>';
                     sources.push(p);
                   }

            //missions
            var missionTag1 = props.mission_tag1;
            var missionTag2 = props.mission_tag2;
            var missionTag3 = props.mission_tag3;
            var missionTag4 = props.mission_tag4;
            var mission_arr = [];

            if(missionTag1){
              mission_arr.push(missionTag1);
            }
            if(missionTag2){
              mission_arr.push(missionTag2);
            }
            if(missionTag3){
              mission_arr.push(missionTag3);
            }
            if(missionTag4){
              mission_arr.push(missionTag4);
            }

            //actual infobox text
            var html = '<h4>' + props.location_descriptive + '</h4>';

            html += '<strong>Operating Entity:</strong> ' + props.operating_entity + '<br/>';

            html += '<strong>Dates:</strong> ' + props.date_begun + ' - ' + props.date_ended + '<br/>';

            html += '<strong>Drone Type:</strong> ';
              if(props.drone_type == 'N/A'){
                 html += 'Multiple, Other, or Unknown<br/>';
                }
              else {html += props.drone_type + '<br/>';}

            html += '<strong>Model:</strong> ';
              if(props.drone_model_name == 'N/A'){
                 html += 'Unknown or Not Applicable<br/>';
                }
              else {html += props.drone_model_name + '<br/>';}

            html += '<strong>Manufacturer:</strong> ';
              if(props.drone_manufacturer == 'N/A'){
                 html += 'Unknown or Not Applicable<br/>';
                }
              else {html += props.drone_manufacturer + '<br/>';}

            html += '<strong>Camera:</strong> ';
              if(props.camera_equipment == 'N/A'){
                 html += 'Unknown or Not Applicable<br/>';
                }
              else {html += props.camera_equipment + '<br/>';}

            html += '<strong>Cost:</strong> ';
              if(props.cost_range == 'N/A'){
                 html += 'Unknown or Not Applicable<br/><br/>';
                }
              else {html += props.cost_range + '<br/><br/>';}

            html += '<strong>Type(s) of Mission:</strong> ';
            for(i=0; i<mission_arr.length;i++){
                if(i != mission_arr.length-1){ html += mission_arr[i] + ", ";}
                else { html += mission_arr[i];}
              }
            html +='<br/>';
            html += '<strong>Country:</strong> ' + props.country_name + '<br/>';
            html += '<strong>Location Description:</strong> ' + props.location_descriptive + '<br/>';
            html += '<strong>Description:</strong> ' + props.mission_description + '<br/>';
            html += '<strong>Source(s):</strong> ';
            for(i=0; i<sources.length;i++){
                if(i != sources.length-1){ html += sources[i] + ", ";}
                else { html += sources[i];}
              }

                feature.properties.popupContent = html;
            }

        function initFilters(data) {
          var thisMonth = new Date().getFullYear() * 100 + new Date().getMonth() + 1;
          var range = data.reduce(function(p,c) {
              var date_begun = parseIntSafe(c.properties.date_begun, thisMonth);
              var date_ended = parseIntSafe(c.properties.date_ended, thisMonth);
              if(date_begun < 10000) { date_begun *= 100; }
              if(date_ended < 10000) { date_ended *= 100; }
              return {
                "min": Math.min(p.min, date_begun),
                "max": Math.max(p.max, date_ended)
              }
            },
            { "min": thisMonth, "max": thisMonth });

          $("#date-range").slider({
            "range": true,
            "min": range.min,
            "max": range.max,
            "values": [ range.min, range.max ],
            "slide": applyFilters
          });

          $(".filter").change(applyFilters);
        }

        function parseIntSafe(s, def) { return isNaN(parseInt(s,10)) ? def : parseInt(s,10); }

        // TODO: clean up global
        function render(filteredData) {
          if(myLayer) { map.removeLayer(myLayer); }

          myLayer = L.geoJson(filteredData, {
              pointToLayer: function (feature, latlng) {
                  return L.circleMarker(latlng, markerOptions);
              },
              onEachFeature: onEachFeature
          });

          myLayer.addTo(map);
        }

        function applyFilters(e) {
          var minDate = $("#date-range").slider("values", 0);
          var maxDate = $("#date-range").slider("values", 1);

          // `data` is a global
          var filteredData = data.features.filter(function(d) {
              var pass_mission_filter = [
                  "default", // this is the "unfiltered" selection
                  d.properties.mission_tag1,
                  d.properties.mission_tag2,
                  d.properties.mission_tag3,
                  d.properties.mission_tag4
                ].indexOf($("#missionFilter").val()) > -1;

              var date_begun = parseIntSafe(d.properties.date_begun, 0);
              var date_ended = parseIntSafe(d.properties.date_ended, 999912);
              var pass_date_filter = (date_begun < maxDate && date_ended > minDate);

              var pass_cost_filter = [
                  "default",
                  d.properties.over_under_10k
                ].indexOf($("#costFilter").val()) > -1;

              var pass_type_filter = [
                  "default",
                  d.properties.drone_type
                ].indexOf($("#typeFilter").val()) > -1;

              return pass_mission_filter &&
                  pass_date_filter &&
                  pass_cost_filter &&
                  pass_type_filter;
          });

          render(filteredData);
        }

        $(document).ready(function() {
          render(data.features);
          initFilters(data.features);
        });

</script>
</body>
</html>
